# Hardware Testbed and Large-scale Testbed Co-simulation based Hardware in Loop Simulation

## Overview

**H**ardware **T**est**B**ed and **L**arge-scale **T**est**B**ed Co-Simulation (HLTB Co-Sim) is a real-time hybrid EMT-phasor simulation for Hardware in Loop (HIL) Simulation.

## Background

**H**ardware **T**est**B**ed (HTB) is a power electronic-based power system emulators[^1], and **L**arge-scale **T**est**B**ed (LTB)[^3][^4] is a large-scale power system simulation that can be used as virtual grid or digital twin of a real power grid.

## Installation

Create an environment HLC for the co-sim (recommended)

```
conda create --name hlc python=3.8
```

Activate the environment

```
conda activate hlc
```

Install the required packages

```
pip install -r requirements.txt
```

Then you have a working Python environment named ``hlc``.

## Data I/O

Data IO from HTB to LTB is converted by a linear function:

$$
y = htb_{s}\cdot x + htb_{b}
$$

where $x$ is the data from HTB (converted from ***HEX*** to ***DEC***), $y$ is the output,$htb_{s}$ is the scale factor, and $htb_{b}$ is the bias.

In contrast, data IO from LTB to HTB is converted by a linear function:

$$
y = htb_{s}\cdot x
$$

where $x$ is the data from LTB, $y$ is the data to HTB, $htb_{s}$ is the scale factor.

Data IO configuration is stored in a dict ``io_config``:

```python
"""
Configurations
--------------
k_df: int
    default counter value
p_df: float
    default active power
q_df: float
    default reactive power
k_pu: float
    scaler of p.u., convert data from HTB base to LTB base
"""
```

## Co-Simulation

Counter generated by HTB is a loop of integers from 11 to 199.

Counter is calculated by a linear function:

$$
k = k_{s}\cdot k_r + k_{b}
$$

where $k_r$ is the counter read from HTB, $k$ is the actual counter, $k_{s}$ is the scale factor, and $k_{b}$ is the bias.

Co-simulation status are stored in a dict ``cs_stat``:

```python
"""
Status
------
iter_total: int
    Number of total iterations
iter_fail: int
    Number of failed iterations
ks: int
    Counter base
kb: int
    Counter bias
"""
```

Co-simulation configurations are stored in a dict ``cs_config``:

```python
"""
Configurations
--------------
ti: float
    Starting point of TDS
t_step: float
    Time step of co-simulation
t_total: float
    Time length of co-simulation
itermax_io: int
    Maximum iteration number of data IO
load_switch: bool
    Switch of load, True for HTB load on, False for load off
"""
```

Co-simulation timeseries data are stored in a pandas DataFrame ``csdata``:

```python
"""
Data
----
ks: int
    Counter base
kb: int
    Counter bias
kr: int
    Read counter
freq: float
    Frequency from LTB
volt: float
    Voltage from LTB
p: float
    Active power from HTB
q: float
    Reactive power from HTB
tw: float
    Time to write
tr: float
    Time to read
"""
```

## HTB-LTB Co-Simulation Operation Procedure

The LTB part should be started first:

In an Anaconda Terminal (windows start menu), change the path to the working path

```
cd $HOME:\hlcosim\
```

Activate the HLC environment

```
conda activate hlc
```

Open Jupyter Notebook

```
jupyter notebook
```

[^1]: L. M. Tolbert et al., "Reconfigurable Real-Time Power Grid Emulator for Systems With High Penetration of Renewables," in IEEE Open Access Journal of Power and Energy, vol. 7, pp. 489-500, 2020, doi: [10.1109/OAJPE.2020.3030219](https://ieeexplore.ieee.org/document/9220900).
    
[^2]: F. Li, K. Tomsovic and H. Cui, "A Large-Scale Testbed as a Virtual Power Grid: For Closed-Loop Controls in Research and Testing," in IEEE Power and Energy Magazine, vol. 18, no. 2, pp. 60-68, March-April 2020, doi: [10.1109/MPE.2019.2959054](https://ieeexplore.ieee.org/document/9007798).
    
[^3]: H. Cui, F. Li and K. Tomsovic, "Hybrid Symbolic-Numeric Framework for Power System Modeling and Analysis," in IEEE Transactions on Power Systems, vol. 36, no. 2, pp. 1373-1384, March 2021, doi: [10.1109/TPWRS.2020.3017019](https://ieeexplore.ieee.org/document/9169830).
    
[^4]: Parsly, N., Wang, J., West, N., Zhang, Q., Cui, H., & Li, F. (2022). "DiME and AGVIS A Distributed Messaging Environment and Geographical Visualizer for Large-scale Power System Simulation". arXiv 2022, doi: [arXiv:2211.11990](https://arxiv.org/abs/2211.11990)
